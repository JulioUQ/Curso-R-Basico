---
title: "Curso R - B√°sico"
subtitle: "M√≥dulo 3. Manipulacion de datos con Tidyverse"
author: "Julio √öbeda Quesada"
date: "`r format(Sys.time(), '%d/%m/%Y, %H:%M')`"
abstract: |
 Este documento corresponde al segundo d√≠a del curso b√°sico de R...
output: 
  html_document:
    df_print: paged
    theme: united
    toc: true
    toc_float: true
---

<!-- INITIALIZATION -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
```

<!-- LIBRERIAS -->

Antes de comenzar con el an√°lisis de datos, es importante establecer el espacio de trabajo y cargar los paquetes necesarios. Este bloque de c√≥digo prepara el entorno para trabajar con el paquete tidyverse y otros recursos √∫tiles como kableExtra y knitr.

```{r load_libraries, include=FALSE, results='hide'}
rm(list=ls())

#--------------ESPACIO DE TRABAJO Y RUTAS RELATIVAS---------------#
# Modificar por el path del directorio de trabajo 
home_file  = "C:/Users/jubeda2/Downloads/Curso R Basico/Modulo 2. Matrices, factores y datatables"
data_loc   = paste0(home_file,"/3. Datos/")
fig_loc    = paste0(home_file,"/4. Figuras y graficos/")
Output_loc = paste0(home_file, "/5. Outputs/")

#--------------PAQUETES NECESARIOS PARA EL CURSO---------------#
Packages = c("tidyverse", "kableExtra", "knitr")

# Instalar los paquetes que no est√©n instalados
new_packages <- Packages[!(Packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Cargar los paquetes
lapply(Packages, library, character.only = TRUE)
```

# Manipulaci√≥n de datos con Tidyverse

Vamos a trabajar con el dataset DatosPesca, que contiene informaci√≥n sobre desembarques de la flota espa√±ola en la zona de pesca 27. Utilizaremos funciones del paquete dplyr para manipular y explorar estos datos de forma eficiente.

```{r, Input}
# Definir la ruta del archivo
file_path <- paste0(data_loc, "DatosPesca.xlsx")

# Cargar el archivo Excel
df <- read_excel(file_path)

# Mostramos la estructura del dataset
cat("La estructura del conjunto de datos de pesqueros en la zona 27:\n\n")
str(df)
```

## `filter()` ‚Äî Filtrar registros relevantes

Filtrar observaciones es una de las tareas m√°s frecuentes y √∫tiles al trabajar con datos. La funci√≥n filter() del paquete dplyr nos permite seleccionar filas que cumplen con condiciones espec√≠ficas, haciendo el an√°lisis m√°s focalizado y eficiente.

A continuaci√≥n, se muestran algunos ejemplos pr√°cticos usando el dataset DatosPesca.

```{r, FiltroZona}
# Filtrar desembarques en la zona CIEM 27.7.b
DatosPesca %>%
  filter(Zona == "27.7.b")
```

Este filtro selecciona √∫nicamente las observaciones correspondientes a la subzona CIEM 27.7.b, una zona de pesca espec√≠fica de inter√©s.

```{r, FiltroPesoDesembarcado}
# Filtrar los desembarques cuyo peso total en vivo supera los 500 kg
DatosPesca %>%
  filter(PesoDesembarcadoVivoTotal > 500)
```

Aqu√≠ estamos interesados en capturas de gran volumen, descartando los registros m√°s peque√±os para centrarnos en las m√°s representativas.

```{r, FiltroArtePesca}
# Filtrar registros en los que se haya utilizado el arte de pesca OTB (arrastre de fondo)
DatosPesca %>%
  filter(CodigoArte == "OTB")
```

El c√≥digo de arte "OTB" corresponde al arrastre de fondo. Este filtro nos permite analizar exclusivamente las capturas realizadas con este tipo de arte.

## `mutate()` ‚Äî Crear nuevas columnas

La funci√≥n mutate() de dplyr permite crear nuevas variables o transformar las existentes en un dataframe. Es especialmente √∫til cuando necesitamos derivar informaci√≥n adicional a partir de los datos originales, como convertir unidades o calcular proporciones.

Veamos algunos ejemplos √∫tiles en el contexto del an√°lisis pesquero:

```{r, MutateToneladas}
# Crear una nueva columna que convierte el peso vivo total de kilogramos a toneladas
DatosPesca %>%
  mutate(toneladas = PesoDesembarcadoVivoTotal / 1000)
```

Este ejemplo crea una nueva variable llamada toneladas, dividiendo los valores en kilogramos entre 1000. Esta transformaci√≥n facilita la lectura y el an√°lisis cuando se trabaja con grandes vol√∫menes.

```{r, Mutateprop_bajo_talla}
# Calcular la proporci√≥n de capturas bajo talla sobre el total
DatosPesca %>%
  mutate(prop_bajo_talla = PesoDesembarcadoVivoBajoTalla / PesoDesembarcadoVivoTotal)
```

Aqu√≠ calculamos la proporci√≥n de capturas por debajo de la talla m√≠nima legal, una m√©trica clave para evaluar la sostenibilidad de la actividad pesquera.

> Consejo: Puedes encadenar varias transformaciones dentro de un mismo mutate():

```{r, MultiMutate}
# Crear ambas variables en un solo paso
DatosPesca %>%
  mutate(
    toneladas = PesoDesembarcadoVivoTotal / 1000,
    prop_bajo_talla = PesoDesembarcadoVivoBajoTalla / PesoDesembarcadoVivoTotal
  )
```

Esto ahorra l√≠neas de c√≥digo y mejora la legibilidad del script.

## `rename()` ‚Äî Renombrar columnas para mayor claridad

Cuando trabajas con datasets provenientes de sistemas administrativos o bases externas, los nombres de columnas suelen ser poco descriptivos o demasiado t√©cnicos. Con rename() puedes asignar nombres m√°s claros y legibles, lo que facilita el an√°lisis y la comunicaci√≥n de resultados.

```{r, rename_1}
DatosPesca %>%
  rename(
    Especie = AL3Especie,
    Peso_kg = PesoDesembarcadoVivoTotal,
    ArtePesca = CodigoArte
  )
```

Este ejemplo renombra tres columnas:

- AL3Especie ‚Üí Especie
- PesoDesembarcadoVivoTotal ‚Üí Peso_kg
- CodigoArte ‚Üí ArtePesca

Esto hace que las columnas tengan nombres m√°s intuitivos, especialmente √∫til al presentar resultados a audiencias no t√©cnicas.


## üß† `summarize()` + `group_by()` ‚Äî Res√∫menes por grupo

La combinaci√≥n de group_by() y summarize() permite agrupar datos por una o m√°s variables y luego calcular res√∫menes estad√≠sticos como totales, medias o proporciones.

Esto es fundamental para obtener resultados agregados, como el total desembarcado por especie o el porcentaje de capturas bajo talla.

```{r, Groupby_1}
# Total desembarcado por especie
DatosPesca %>%
  group_by(AL3Especie) %>%
  summarize(total_kg = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE))
```

Agrupa los datos por especie (AL3Especie) y calcula el total de kilogramos desembarcados para cada una.

```{r, Groupby_2}
# Captura promedio mensual por especie
DatosPesca %>%
  group_by(AL3Especie, MONTH) %>%
  summarize(promedio_mensual = mean(PesoDesembarcadoVivoTotal, na.rm = TRUE))
```

Este resumen incluye dos niveles de agrupaci√≥n: por especie y por mes. Nos ayuda a identificar patrones estacionales en las capturas.

```{r}
# Porcentaje de capturas bajo talla por especie
DatosPesca %>%
  group_by(AL3Especie) %>%
  summarize(
    total = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE),
    bajo_talla = sum(PesoDesembarcadoVivoBajoTalla, na.rm = TRUE),
    pct_bajo_talla = bajo_talla / total * 100
  )
```

Este bloque calcula el porcentaje de peso bajo talla para cada especie, una m√©trica clave para evaluar la sostenibilidad pesquera.

## üîó `ungroup()` ‚Äî Eliminar agrupaciones para siguientes an√°lisis

Despu√©s de aplicar group_by(), los datos quedan agrupados internamente, lo cual puede afectar pasos posteriores. Usar ungroup() elimina esa agrupaci√≥n, permitiendo continuar con otras operaciones sin heredar ese comportamiento.

```{r, Ungroup}
# Total por especie, luego desagrupar y ordenar
DatosPesca %>%
  group_by(AL3Especie) %>%
  summarize(total_kg = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(total_kg))
```

Este ejemplo resume por especie, elimina la agrupaci√≥n y ordena el resultado para mostrar primero las especies con mayor volumen de desembarque.

## üìã `select()` ‚Äî Seleccionar columnas √∫tiles (1)

La funci√≥n select() nos permite elegir √∫nicamente las columnas necesarias para un an√°lisis, visualizaci√≥n o reporte. Esto ayuda a trabajar con dataframes m√°s ligeros y enfocados.

```{r, SelectVars}
# Seleccionar solo columnas clave para reporte
DatosPesca %>%
  select(YEAR_DC, MONTH, AL3Especie, Zona, CodigoArte, PesoDesembarcadoVivoTotal)
```

Este ejemplo extrae solo las columnas relevantes: a√±o, mes, especie, zona, arte de pesca y peso total desembarcado. Ideal para preparar datos antes de graficar o exportar.

```{r}
# Excluir variables de registro administrativo
DatosPesca %>%
  select(-CODREG, -TIPOREG, -CLASIFICACION_MAREA)
```

Aqu√≠ usamos - para eliminar variables que no son √∫tiles para el an√°lisis. Esto simplifica el conjunto de datos sin perder informaci√≥n relevante.

## üìã `select()` ‚Äî Seleccionar columnas √∫tiles (2)

Puedes combinar select() con funciones auxiliares como:

- `starts_with("...")` ‚Äî selecciona columnas que comienzan con cierto texto.
- `ends_with("...")` ‚Äî columnas que terminan con cierto texto.
- `contains("...")` ‚Äî columnas que contienen una cadena espec√≠fica.

```{r, Regular}
DatosPesca %>%
  select(
    starts_with("Peso"),       # Columnas que empiezan con "Peso"
    ends_with("Total"),        # Columnas que terminan en "Total"
    contains("Arte")           # Columnas que contienen la palabra "Arte"
  )
```

## üîΩ `arrange()` ‚Äî Ordenar datos para interpretaci√≥n

Ordenar los datos permite detectar patrones importantes como los mayores vol√∫menes de captura por especie o puerto. Con arrange() de dplyr, puedes organizar los resultados en orden ascendente o descendente, lo que mejora la claridad del an√°lisis.

```{r, arrange_1}
# Ordenar especies por mayor desembarque
DatosPesca %>%
  group_by(AL3Especie) %>%
  summarize(total_kg = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE)) %>%
  arrange(desc(total_kg))
```

Este bloque agrupa por especie (AL3Especie), calcula el total desembarcado y luego ordena las especies de mayor a menor volumen (desc() se utiliza para ordenar de mayor a menor).

```{r, arrange2}
# Ordenar puertos por volumen desembarcado
DatosPesca %>%
  group_by(PuertoDesembarque) %>%
  summarize(volumen = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE)) %>%
  arrange(desc(volumen))
```

Aqu√≠ agrupamos por puerto de desembarque y ordenamos seg√∫n el volumen total capturado. Esto permite identificar los principales puntos log√≠sticos de desembarque.

## üìà Bonus: Gr√°ficos r√°pidos con `ggplot2`

```{r}
# Captura mensual por especie (top 5)
top_especies <- DatosPesca %>%
  group_by(AL3Especie) %>%
  summarize(total = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE)) %>%
  slice_max(order_by = total, n = 5) %>%
  pull(AL3Especie)

DatosPesca %>%
  filter(AL3Especie %in% top_especies) %>%
  group_by(AL3Especie, MONTH) %>%
  summarize(total = sum(PesoDesembarcadoVivoTotal, na.rm = TRUE)) %>%
  ggplot(aes(x = MONTH, y = total, color = AL3Especie)) +
  geom_line(size = 1.2) +
  labs(title = "Captura mensual por especie (Top 5)", y = "kg", x = "Mes") +
  theme_minimal()
```

---

## ‚úÖ Conclusiones
